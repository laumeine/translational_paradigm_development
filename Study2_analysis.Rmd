---
title: "Analyses for 'A Translational Paradigm to Study the Effects of Uncontrollable Stress in Humans'"
subtitle: "Study 2 Analysis"
author: "Laura E. Meine and Katja Schueler"
date: "25.06.2020"
output:
   html_document:
    theme: flatly
    toc: yes
    toc_float: yes
    number_sections: true
---

```{r setup, include=FALSE}
knitr:: opts_chunk$set(cache = TRUE, echo = FALSE, warning = FALSE, message = FALSE, fig.align="center")
```
# Summary

This script runs analyses on data from study 2. Specifically, it compares data from two groups of participants who underwent escapable stress (EC) or yoked inescapable stress (YC), respectively. We use the terms "group" and "condition" interchangeably. . Measurements under investigation comprised reaction times (RTs) and ratings under acute stress (stressor aversiveness, control, exhaustion, helplessness) as well as pre-post changes in affective state (STADI and PANAS questionnaires), and effects escape behaviour (activity, exploration, escapes, efficiency).

```{r load libraries}
library(tidyverse) 
library(afex) 
library(ggpubr) # for easy plotting
library(rstatix) 
library(Rmisc) 
library(lsmeans) 
library(effsize)
library(WRS2) # for robust ANOVA
```

```{r create ggplot theme}
# set standard ggplot theme
laura_theme <- theme(panel.border = element_rect(colour="black", fill="transparent", size=1),
                     panel.background = element_rect(fill="transparent"),
                     axis.line = element_line(colour="black"),
                     panel.grid.minor = element_line(colour="transparent"),
                     axis.title.x = element_text(size=16, vjust=-.25),
                     axis.title.y = element_text(size=16, vjust=1),
                     axis.text.x = element_text(size=14, colour="black"),
                     axis.text.y = element_text(size=14, colour="black"),
                     strip.text.x = element_text(size = 20),
                     legend.text=element_text(size=14),
                     legend.title = element_text(size = 16))

# define 2 theme colours to use (colorblind-friendly, s. http://www.cookbook-r.com/Graphs/Colors_(ggplot2)/)
colour1 = "#009E73" 
colour2 = "#D55E00" 
```

```{r import data}
# read in study 2 data
demo <- read.csv("study2_data/study2_demographics.csv", header=T)
stress <- read.csv("study2_data/study2_stress_induction.csv", sep=";", header=T)
affStates <- read.csv("study2_data/study2_affect_states.csv", sep=";", header=T)
escapeBehav <- read.csv("study2_data/study2_escape_behaviour.csv", sep=";", header=T)
```

# Sample Descriptives

```{r sample descriptives}
# define variables to shorten code
EC <- demo$condition=="EC"
YC <- demo$condition=="YC"

# function for plotting
stat_sum_single <- function(fun, geom="point", ...) {
  stat_summary(fun.y=fun, shape = 23, fill = "white", geom = geom, size = 3, ...)} #summarise y values

# sample sizes
N <- nrow(demo) # 100
n <- table(demo$condition) # 62 EC, 38 YC
```
In total, the sample consisted of *N* = `r N` participants with *n* = `r n[1]` in EC and *n* = `r n[2]` in YC. 

## Age & Sex
```{r plot age by sex}
demo$sex <- ifelse(demo$sex==2, "m", "f") # rename sex variable levels for more intuitive results
demo$sex <- as.factor(demo$sex)

# percent female
ec.f <- (table(demo$sex[EC])[1]/nrow(demo[EC,]))*100
yc.f <- (table(demo$sex[YC])[1]/nrow(demo[YC,]))*100

# age by condition
age_descr <- summarySE(demo, measurevar="age", groupvars="condition", conf.interval=.95) 

# plot age distribution by sex
ageHist <- ggplot(demo, aes(x = trunc(age), fill = sex)) +
  geom_histogram(colour = "white", bins = 14) +
  scale_fill_manual(values = c(colour1, colour2), name="Sex") +
  xlab("Age") +
  laura_theme
ageHist
```

# A priori Group Difference Checks

## Sex (Chi-square Test)
```{r check sex}
# run chi-square test
chisqSex <- chisq.test(demo$condition, demo$sex)
chisqSex
```
There were no a priori group differences in male-female ratio.

## Age (t-test)
```{r check age - prep, include = FALSE}
# check for outliers by group
ageOutlier <- ggplot(demo, aes(condition, age, fill=condition)) + 
    geom_violin() +
    geom_boxplot(width=0.2) +
    stat_sum_single(mean) +
    xlab("Experimental Condition") +
    ylab("Age") +
    scale_fill_manual(values=c(colour1, colour2)) +
    laura_theme
ageOutlier # some outliers

# get outlier IDs
ageOutlierIDs <- demo %>%
  group_by(condition) %>%
  identify_outliers(age)

# output outlier IDs
#unique(ageOutlierIDs$ID) 

# exclude all identified outliers
#demo_age <- demo[! (demo$ID=="EC06" | demo$ID=="EC25" |
#               demo$ID=="EC30" | demo$ID=="CSE107" |
#                demo$ID=="CSE64"), ]

# output extreme outliers
#unique(ageOutlierIDs$ID[ageOutlierIDs$is.extreme==T]) # 2 38-year-olds

# exclude extreme outliers
#demo_age <- demo[! (demo$ID=="EC06" | demo$ID=="EC25"), ]
```
```{r check age - t-test}
# run t.test for independent samples to check for significant differences in age
t.test(demo$age[demo$condition=="EC"], demo$age[demo$condition=="YC"], paired=F, var.equal=T) 

# trend effect

# get cohen's d
cohen.d(demo$age[demo$condition=="EC"], demo$age[demo$condition=="YC"])

# age outliers don't affect other analyses 
```
There were some outliers and we checked for the 2 extreme cases but rerunning all analyses without those did not change the results, so we kept them. Overall, there were no differences in age across groups.

## Level of Education
```{r check education}
# level of education: 1 = , 2 = ..., 6 = Fachhochschulreife, 7 = Abitur, 8 = , 9 = , 10 = Bachelor, 11 = Master/Staatsexamen/Diplom, 12 = PhD - get missing info!

# get reported levels
educationLevels <- levels(as.factor(demo$education_level)) # 6,7,10,11

# education by condition
edu_descr <- summarySE(demo, measurevar="education_level", groupvars="condition", conf.interval=.95) 

eduOutlier <- ggplot(demo, aes(condition, education_level, fill=condition)) + 
    geom_boxplot(width=0.2) +
    geom_point(position = position_jitter(w = 0.3, h = 0)) +  
    stat_sum_single(mean) +
    scale_y_continuous(breaks=c(1:12), limits=c(1,12)) +
    xlab("Experimental Condition") +
    ylab("Level of Education") +
    scale_fill_manual(values=c(colour1, colour2)) +
    laura_theme
eduOutlier # some outliers

# Wilcoxon rank sum test
edu.test <- demo %>% 
  wilcox_test(education_level ~ condition) %>%
  add_significance()
edu.test

# no group differences

# get wilcoxon's r as measure of effect size
demo %>% wilcox_effsize(education_level ~ condition)
```
There were no a priori group differences with respect to level of education. 

```{r add demopgraphic variables to data}
# add demographic variables to other data frames 
stress <- merge(demo, stress, by=("ID"), all=T)
affStates <- merge(demo, affStates, by=("ID"), all=T)
escapeBehav <- merge(demo, escapeBehav, by=("ID"), all=T)
```

# Manipulation Check

## Verify Yoking of Stress Durations
```{r yoking check}
# plot stress_duration by trial and condition
stressDurPlot <- ggplot(stress, aes(trial, stress_duration, fill=condition)) +
  geom_bar(stat = "summary", position="dodge", fun.y="mean") + 
  scale_x_continuous(breaks=seq(1,60,1)) +
  ylim(0,15) + # max. possible duration was 10s
  ylab("Stress Duration (s)") +
  xlab("Trial") +
  laura_theme + theme(axis.text.x = element_text(size = 6)) +
  scale_fill_manual(values=c(colour1, colour2))
stressDurPlot

# run t-test for independent samples
t.test(stress$stress_duration[stress$condition=="EC"], stress$stress_duration[stress$condition=="YC"], paired=F, var.equal=T) # n.s.
```
There were no overall differences in overall stress durations between EC and YC because YC participants were pseudoyoked to EC. Very slight timing inaccurracies are due to program execution differences. Note that durations across trials differ between groups. We deliberately introduced a discount of max. stress exposure in EC to enhance the feeling of control. In YC, we randomly shuffled stress durations obtained from EC to enhance the feeling of arbitrary stress durations outside the participant's control.

## Assess Performance in EC
```{r check EC performance}
# correct performance by condition
correct_group_descr <- summarySE(stress, measurevar="correct", groupvars="condition", conf.interval=.95, na.rm=T) 

# correct performance by ID
correct_ID_descr <- summarySE(stress, measurevar="correct", groupvars="ID", conf.interval=.95, na.rm=T) 

# we should maybe exclude EC participants that have less than a third correct because they would obviously have experienced little control which would void our manipulation (cf. Hartley et al., 2014)

correct_ID_descr <- merge(correct_ID_descr, demo[, c(1,2)], by=("ID"), all=T) # add condition again

# get EC ID's with low performance
nECLowCorrect <- length(correct_ID_descr$ID[correct_ID_descr$condition=="EC" & correct_ID_descr$correct<.30])
ECremain <- n[1]-nECLowCorrect

#54 ECs remain

# exclude ECLowCorrect participants to assess whether results in subsequent analyses change
#stress <- stress[! (stress$ID=="EC16" | stress$ID=="EC18" | stress$ID=="EC24" |
#                     stress$ID=="EC46" | stress$ID=="EC51" | stress$ID=="EC80" |
#                     stress$ID=="EC82" | stress$ID=="EC84"), ]

ECcorrect.m <- mean(stress$correct[stress$condition=="EC"], na.rm=T)
ECcorrect.sd <- sd(stress$correct[stress$condition=="EC"], na.rm=T)
```
`r nECLowCorrect` EC participants had less than 30% correct trials, however, excluding them did not affect subsequent results, so we kept them.

```{r prepare rating data}
# extract rating rows (every 15th trial = 4 ratings per ID)
ratings <- stress[seq(0, nrow(stress), 15), ]

# calculate mean ratings by ID
ratingMean <- ratings %>%   group_by(ID) %>%  summarise_all(funs(mean(., na.rm = TRUE)))
ratingMean <- ratingMean[, -c(2,5,6,9,10,12)] # delete unnecessary columns
ratingMean <- merge(ratingMean, demo[, c(1,2)], by=("ID"), all=T) # add condition again
```

## Stressor Aversiveness
```{r manipulation check - stressor aversiveness ratings, plot to identify outliers}
# exclude cases with missing responses (1 YC)
#unique(ratings$ID[is.na(ratings$aversive_rating)]) # CSE02
ratings_avers <- ratings[ratings$ID!="CSE02", ]
ratingMean_avers <- ratingMean[ratingMean$ID!="CSE02", ]

# verify that stressor was rated as aversive in EC and YC
avers.m <- mean(ratingMean_avers$aversive_rating) # global mean rating

# boxplot by group and trial
aversBoxPlot <- ggplot(ratings_avers, aes(factor(trial), aversive_rating, fill=condition)) + 
  geom_violin() +  
  geom_boxplot(width=0.2, position=position_dodge(1)) +
    ylab("Stressor Aversiveness") +
    xlab("Trial") +
    scale_fill_manual(values=c(colour1, colour2)) +
    laura_theme
aversBoxPlot # some outliers

# check for outliers by group and trial (this is more sensitive because e.g. shock electrode may not have transmitted properly in some trials)
aversOutlierIDs <- ratings_avers %>%
  group_by(condition, trial) %>%
  identify_outliers(aversive_rating) # 4 outliers

# output all outliers
#unique(aversOutlierIDs$ID) 

# exclude all identified outliers
ratings_avers <- ratings_avers[! (ratings_avers$ID=="CSE30" | ratings_avers$ID=="CSE68" |
                                   ratings_avers$ID=="CSE74" | ratings_avers$ID=="CSE60"), ] #doesn't change results but it might make sense to exclude them because aversiveness was specifically calibrated and low ratings are likely due to electrode malfunctioning etc. (although only one participant continuously rated stressor as low aversiveness and correspondingly showed low helplessness ratings, the other participants show only temporary low aversiveness and this does not link to their other ratings)

# output extreme outliers
#unique(aversOutlierIDs$ID[aversOutlierIDs$is.extreme==T]) # none
```
There were outliers with particularly low aversiveness ratings which we excluded from this analysis.

```{r manipulation check - stressor aversiveness ratings}
# aversiveness ratings by condition
avers_group_descr <- summarySE(ratingMean_avers, measurevar="aversive_rating", groupvars="condition", conf.interval=.95) 

# aversiveness ratings by condition and trial
avers_trial_descr <- summarySEwithin(ratings_avers, measurevar="aversive_rating", betweenvars="condition", withinvars="trial", idvar="ID", conf.interval=.95) 

# aversiveness ratings by condition, trial, and sex
avers_trial_sex_descr <- summarySEwithin(ratings_avers, measurevar="aversive_rating", betweenvars=c("condition", "sex"), withinvars="trial", idvar="ID", conf.interval=.95) 

# plot ratings across trials by group
aversPlot <- ggplot(avers_trial_descr, aes(as.numeric(as.character(trial)), aversive_rating, colour=condition)) +
  geom_line(size=1) +
  geom_errorbar(aes(ymin=aversive_rating-se, ymax=aversive_rating+se), width=.1) +
  scale_y_continuous(breaks=c(1:7), limits=c(0.9,7.1)) + # max. possible rating was 7
  ylab("Stressor Aversiveness") +
  xlab("Trial") +
  scale_color_manual(values=c(colour1, colour2))  +
  laura_theme
aversPlot

# test whether groups differed in stressor aversiveness and whether ratings changed over time
# rmANOVA with condition and trial and sex as covariate

# check normality assumption
aversqqplot <- ggqqplot(ratings_avers, "aversive_rating", ggtheme = theme_bw()) +
  facet_grid(trial ~ condition, labeller = "label_both") # looks acceptable
#aversqqplot

# run rmANOVA
avers.fit <- aov_ez("ID","aversive_rating", ratings_avers, between="condition", within="trial", covariate="sex") #sphericity is automatically checked and corrected if needed
summary(avers.fit) 
#nice(avers.fit)
nice(avers.fit, es="pes")

# no main effect of group, EC and YC both rate stress as very aversive
# no main effect of trial
# sig. effect of sex (men rate stressor as less aversive)

# plot ratings split for sex
aversSexPlot <- ggboxplot(
  ratings_avers, x = "sex", y = "aversive_rating",
  facet.by = "condition", short.panel.labs = FALSE)
aversSexPlot
```
Both EC and YC rated the stressor as very aversive (global *M* = `r avers.m`). Mean aversiveness ratings did not differ between groups. Stressor aversiveness ratings remained constant over time. Men reported lower stressor aversiveness compared to women.

## Perceived Stressor Controllability
```{r manipulation check - controllability ratings, plot to identify outliers}
# boxplot by group and trial
ctrlBoxPlot <- ggplot(ratings, aes(factor(trial), control_rating, fill=condition)) + 
  geom_violin() +  
  geom_boxplot(width=0.2, position=position_dodge(1)) +
    ylab("Perceived Control") +
    xlab("Trial") +
    scale_fill_manual(values=c(colour1, colour2)) +
    laura_theme
ctrlBoxPlot # some outliers

# get outlier IDs
ctrlOutlierIDs <- ratings %>%
  group_by(condition, trial) %>%
  identify_outliers(control_rating)

# output all outliers
#unique(ctrlOutlierIDs$ID) 

# exclude all identified outliers
ratings_ctrl <- ratings[! (ratings$ID=="CSE63" | ratings$ID=="CSE65" |
                           ratings$ID=="CSE68" | ratings$ID=="CSE02" | 
                           ratings$ID=="CSE60"), ] #changes results significantly

ratingMean_ctrl <- ratingMean <- ratingMean[! (ratingMean$ID=="CSE63" | ratingMean$ID=="CSE65" |
                           ratingMean$ID=="CSE68" | ratingMean$ID=="CSE02" | 
                           ratingMean$ID=="CSE60"), ] 
# output extreme outliers
#unique(ctrlOutlierIDs$ID[ctrlOutlierIDs$is.extreme==T]) # none
```
There were some outliers with respect to perceived control and we excluded them since this changed results significantly.

```{r manipulation check - controllability ratings}
# controllability ratings by condition
ctrl_group_descr <- summarySE(ratingMean, measurevar="control_rating", groupvars="condition", conf.interval=.95) 

# controllability ratings by condition and trial
ctrl_trial_descr <- summarySEwithin(ratings, measurevar="control_rating", betweenvars="condition", withinvars="trial", idvar="ID", conf.interval=.95) 

# controllability ratings by condition, trial, and sex
ctrl_trial_sex_descr <- summarySEwithin(ratings, measurevar="control_rating", betweenvars=c("condition", "sex"), withinvars="trial", idvar="ID", conf.interval=.95) 

# plot ratings across trials by group
ctrlPlot <- ggplot(ctrl_trial_descr, aes(as.numeric(as.character(trial)), control_rating, colour=condition)) +
  geom_line(size=1) +
  geom_errorbar(aes(ymin=control_rating-se, ymax=control_rating+se), width=.1) +
  scale_y_continuous(breaks=c(1:7), limits=c(0.9,7.1)) +
  ylab("Perceived Control") +
  xlab("Trial") +
  scale_color_manual(values=c(colour1, colour2))  +
  laura_theme
ctrlPlot

# rmANOVA with condition and trial and sex as covariate

# check normality assumption
ctrlqqplot <- ggqqplot(ratings, "control_rating", ggtheme = theme_bw()) +
  facet_grid(trial ~ condition, labeller = "label_both") # looks ok
#ctrlqqplot

# run rmANOVA
ctrl.fit <- aov_ez("ID","control_rating", ratings_ctrl, between="condition", within="trial", covariate="sex")
summary(ctrl.fit)
nice(ctrl.fit, es="pes")

# main effect of condition
# main effect of trial
# trend for interaction of condition x trial after outliers are excluded
# no sex differences

# post-hoc comparisons - trial
ref1 <- lsmeans(ctrl.fit, specs = "trial")
pwc <- contrast(ref1, method="pairwise", adjust="holm")
pwc

# perceived control increased, especially towards the end of the experiment

# confirm results with robust ANOVA
ctrl.fitrobust <- bwtrim(control_rating ~ condition*factor(trial), ID, data = ratings_ctrl) 
ctrl.fitrobust
```
We observed group differences in perceived control in the expected direction: YC reported lower control than EC. Overall perceived control increased over time (not clear why this would be the case in YC). After removal of outliers, there is a trend for an interaction of condition and trial which reflects EC's learning curve with greater success in terminating the stressor over time.

```{r exploratory analysis to investigate individual differences in EC, include = FALSE}
# correlation to test whether performance and perceived control are related
ECctrlCorr <- join(ratingMean[ratingMean$condition=="EC", ], correct_ID_descr)
cor.test(ECctrlCorr$control_rating, ECctrlCorr$correct)
plot(ECctrlCorr$correct, ECctrlCorr$control_rating)

# with higher rates of correct performance come higher ratings of controllability - this was to be expected
```

# RTs and Ratings During Stress Exposure

## RTs
```{r prepare RT data}
# convert to ms
stress$rt <- stress$rt*1000

# calculate mean RT by ID
RTMean <- aggregate(rt ~ ID, stress, FUN=mean)
RTMean <- merge(RTMean, demo[, c(1:3)], by=("ID"), all=T) # add condition and sex again
RTMean$sex.str <- ifelse(RTMean$sex==2,"m", "f" )

# check if there are participants who never reacted to the cue
naRTIDs <- unique(RTMean$ID[is.na(RTMean$rt)]) # none
```
```{r RTs, plot distribution to identify outliers}
# check for outliers by group
RTOutlier <- ggplot(RTMean, aes(condition, rt, fill=condition)) + 
    geom_violin() +
    geom_boxplot(width=0.2) +
    stat_sum_single(mean) +
    xlab("Experimental Condition") +
    ylab("Mean RT") +
    scale_fill_manual(values=c(colour1, colour2)) +
    laura_theme
RTOutlier # 3 outliers

# get outlier IDs
RTOutlierIDs <- RTMean %>%
  group_by(condition) %>%
  identify_outliers(rt)

# output outliers
#unique(RTOutlierIDs$ID)

# exclude all identified outliers
#stress_rt <- stress[! (stress$ID=="EC55" | stress$ID=="EC73" | stress$ID=="EC82"), ] #doesn't affect results 

# output extreme outliers
#unique(RTOutlierIDs$ID[RTOutlierIDs$is.extreme==T]) # none
```
There were 3 outliers excluding them did not affect the results, so we kept them.

```{r RTs}
# RTs by condition
RT_group_descr <- summarySE(RTMean, measurevar="rt", groupvars="condition", conf.interval=.95, na.rm=T) 

# RTs by condition and trial
RT_trial_descr <- summarySEwithin(stress, measurevar="rt", betweenvars="condition", withinvars="trial", idvar="ID", conf.interval=.95, na.rm=T) 

# RTs by condition, trial, and sex
RT_trial_sex_descr <- summarySEwithin(stress, measurevar="rt", betweenvars=c("condition", "sex"), withinvars="trial", idvar="ID", conf.interval=.95, na.rm=T) 

# plot RT across trials by group
RTPlot <- ggplot(RT_trial_descr, aes(as.numeric(as.character(trial)), rt, colour=condition)) +
  geom_line(size=1) +
  geom_errorbar(aes(ymin=rt-se, ymax=rt+se), width=.1) +
  ylab("RT (ms)") +
  xlab("Trial") +
  scale_color_manual(values=c(colour1, colour2))  +
  laura_theme
RTPlot

# rmANOVA with condition and trial and sex as covariate

# check normality assumption
#stress_rt %>%
#  group_by(condition, trial) %>%
#  shapiro_test(rt) 

# robust ANOVA
rt.fitrobust <- bwtrim(rt ~ condition*trial, ID, data = stress) # how to include sex as covariate?
rt.fitrobust

# EC was sig. faster than YC

# get effect sizes
akp.effect(rt ~ condition, data = stress)
akp.effect(rt ~ trial, data = stress)
```
EC were significantly faster than YC. There was no effect of trial.

## Exhaustion
```{r exhaustion ratings, plot to identify outliers}
# boxplot by group and trial
exhstBoxPlot <- ggplot(ratings, aes(factor(trial), exhausted_rating, fill=condition)) + 
  geom_violin() +  
  geom_boxplot(width=0.2, position=position_dodge(1)) +
    ylab("Exhaustion") +
    xlab("Trial") +
    scale_fill_manual(values=c(colour1, colour2)) +
    laura_theme
exhstBoxPlot # no outliers
```
There were no outliers with respect to exhaustion ratings.

```{r exhaustion ratings}
# exhaustion ratings by condition
exhst_group_descr <- summarySE(ratingMean, measurevar="exhausted_rating", groupvars="condition", conf.interval=.95, na.rm=T) 

# exhaustion ratings by condition and trial
exhst_trial_descr <- summarySEwithin(ratings, measurevar="exhausted_rating", betweenvars="condition", withinvars="trial", idvar="ID", conf.interval=.95) 

# exhaustion ratings by condition, trial, and sex
exhst_trial_sex_descr <- summarySEwithin(ratings, measurevar="exhausted_rating", betweenvars=c("condition", "sex"), withinvars="trial", idvar="ID", conf.interval=.95) 

# plot ratings across trials by group
exhstPlot <- ggplot(exhst_trial_descr, aes(as.numeric(as.character(trial)), exhausted_rating, colour=condition)) +
  geom_line(size=1) +
  geom_errorbar(aes(ymin=exhausted_rating-se, ymax=exhausted_rating+se), width=.1) +
  scale_y_continuous(breaks=c(1:7), limits=c(0.9,7.1)) +
  ylab("Exhaustion") +
  xlab("Trial") +
  scale_color_manual(values=c(colour1, colour2))  +
  laura_theme
exhstPlot

# rmANOVA with condition and trial and sex as covariate

# check normality assumption
exhstqqplot <- ggqqplot(ratings, "exhausted_rating", ggtheme = theme_bw()) +
  facet_grid(trial ~ condition, labeller = "label_both") # looks ok
#exhstqqplot

# run rmANOVA
exhst.fit <- aov_ez("ID","exhausted_rating", ratings, between="condition", within="trial", covariate="sex")
summary(exhst.fit)
nice(exhst.fit, es="pes")

# no main effect of condition 
# main effect of trial, sex effect

# post-hoc comparisons - trial
ref1 <- lsmeans(exhst.fit, specs = "trial")
pwc <- contrast(ref1, method="pairwise", adjust="holm")
pwc

# exhaustion increased and decreased across trials 

# confirm results with robust ANOVA
exhst.fitrobust <- bwtrim(exhausted_rating ~ condition*factor(trial), ID, data = ratings) 
exhst.fitrobust

# plot ratings split for sex
exhstSexPlot <- ggboxplot(
  ratings_avers, x = "sex", y = "exhausted_rating",
  facet.by = "condition", short.panel.labs = FALSE)
exhstSexPlot

# men reported less exhaution
```
There were no group differences in terms of exhaustion ratings. Overall reported exhaustion increased, then decreased over time.

## Feelings of Helplessness
```{r helplessness ratings, plot to identify outliers}
# boxplot by group and trial
helpBoxPlot <- ggplot(ratings, aes(factor(trial), helpless_rating, fill=condition)) + 
  geom_violin() +  
  geom_boxplot(width=0.2, position=position_dodge(1)) +
    ylab("Helplessness") +
    xlab("Trial") +
    scale_fill_manual(values=c(colour1, colour2)) +
    laura_theme
helpBoxPlot # no outiers
```
There were no outliers with respect to helplessness ratings.

```{r helplessness ratings}
# helplessness ratings by condition
help_group_descr <- summarySE(ratingMean, measurevar="helpless_rating", groupvars="condition", conf.interval=.95) 

# helplessness ratings by condition and trial
help_trial_descr <- summarySEwithin(ratings, measurevar="helpless_rating", betweenvars="condition", withinvars="trial", idvar="ID", conf.interval=.95) 

# helplessness ratings by condition, trial, and sex
help_trial_sex_descr <- summarySEwithin(ratings, measurevar="helpless_rating", betweenvars=c("condition", "sex"), withinvars="trial", idvar="ID", conf.interval=.95) 

# plot ratings across trials by group
helpPlot <- ggplot(help_trial_descr, aes(as.numeric(as.character(trial)), helpless_rating, colour=condition)) +
  geom_line(size=1) +
  geom_errorbar(aes(ymin=helpless_rating-se, ymax=helpless_rating+se), width=.1) +
  scale_y_continuous(breaks=c(1:7), limits=c(0.9,7.1)) +
  ylab("Helplessness") +
  xlab("Trial") +
  scale_color_manual(values=c(colour1, colour2))  +
  laura_theme
helpPlot

# rmANOVA with condition and trial and sex as covariate

# check normality assumption
helpqqplot <- ggqqplot(ratings, "helpless_rating", ggtheme = theme_bw()) +
  facet_grid(trial ~ condition, labeller = "label_both") # looks ok
#helpqqplot

# run rmANOVA
help.fit <- aov_ez("ID","helpless_rating", ratings, between="condition", within="trial", covariate="sex")
summary(help.fit)
nice(help.fit, es="pes")

# main effect of condition and trial
# YC reports greater helplessness

# post-hoc comparisons - trial
ref1 <- lsmeans(help.fit, specs = "trial")
pwc <- contrast(ref1, method="pairwise", adjust="holm")
pwc

# helplessness ratings decreased over time

# confirm results with robust ANOVA
help.fitrobust <- bwtrim(helpless_rating ~ condition*factor(trial), ID, data = ratings) # how to include sex as covariate?
help.fitrobust
```
As expected, YC reported greater feelings of helplessness compared to EC. Overall helplessness ratings decreased across trials.

# Changes in Affective State

## Depression and Anxiety (STADI)
```{r depression and anxiety - STADI, plot to identify outliers}
# reorder factor levels for plotting
affStates$time <- factor(affStates$time, levels = c("pre", "post"))

# plot scores by group and time
STADIPlot <- ggplot(affStates, aes(time, STADI_S_Global, fill=condition)) + 
    geom_violin() +  
    geom_boxplot(width=0.2, position=position_dodge(1)) +
    xlab("Time") +
    ylab("Depression and Anxiety") +
    scale_fill_manual(values=c(colour1, colour2)) +
    laura_theme
STADIPlot # some outliers

# get outlier IDs
STADIOutlierIDs <- affStates %>%
  group_by(condition, time) %>%
  identify_outliers(STADI_S_Global)

# output all outliers
#unique(STADIOutlierIDs$ID)

# exclude all identified outliers
#affStatesSTADI <- affStates[! (affStates$ID=="EC53" | affStates$ID=="EC62"), ] # excluding them changes results significantly but not really warranted, no extreme outliers

# output extreme outliers
#unique(STADIOutlierIDs$ID[STADIOutlierIDs$is.extreme==T]) # none
```
There were some outliers with respect to STADI scores but they did not represent extreme outliers, thus we kept them.

```{r depression and anxiety - STADI}
# STADI by condition
STADI_group_descr <- summarySE(affStates, measurevar="STADI_S_Global", groupvars="condition", conf.interval=.95) 

# STADI by condition and time
STADI_time_descr <- summarySEwithin(affStates, measurevar="STADI_S_Global", betweenvars="condition", withinvars="time", idvar="ID", conf.interval=.95) 

# STADI by condition, time, and sex
STADI_time_sex_descr <- summarySEwithin(affStates, measurevar="STADI_S_Global", betweenvars=c("condition", "sex"), withinvars="time", idvar="ID", conf.interval=.95) 

# rmANOVA with condition and time and sex as covariate

# check normality assumption
STADIqqplot <- ggqqplot(affStates, "STADI_S_Global", ggtheme = theme_bw()) +
  facet_grid(time ~ condition, labeller = "label_both") # looks ok but could be better
#STADIqqplot

# run rmANOVA
STADI.fit <- aov_ez("ID","STADI_S_Global", affStates, between="condition", within="time", covariate="sex")
summary(STADI.fit)
nice(STADI.fit, es="pes")

# trend for a group effect, becomes significant if outliers are excluded (YC have slightly higher scores pre and post)
# main effect of time --> pre to post increase in depressive symptoms and anxiety

# confirm results with robust ANOVA
STADI.fitrobust <- bwtrim(STADI_S_Global ~ condition*factor(time), ID, data = affStates) # how to include sex as covariate?
STADI.fitrobust
```
There was a trend effect of group with YC showing slightly higher scores than EC at pre and post. Although both groups reported an sig. increase in depressive symptoms and anxiety from pre to post stress induction, there was no interaction effect, i.e. no differential changes in STADI scores.

## Positive and Negative Mood (PANAS)

### Positive Mood
```{r positive mood - PANASpos, plot to identify outliers}
# plot scores by group and time
PANASposPlot <- ggplot(affStates, aes(time, PANAS_pos, fill=condition)) + 
    geom_violin() +  
    geom_boxplot(width=0.2, position=position_dodge(1)) +
    xlab("Time") +
    ylab("Positive Mood") +
    scale_fill_manual(values=c(colour1, colour2)) +
    laura_theme
PANASposPlot # no outlier
```
There were no outliers with respect to positive mood scores.

```{r positive mood - PANASpos}
# PANASpos by condition
PANASpos_group_descr <- summarySE(affStates, measurevar="PANAS_pos", groupvars="condition", conf.interval=.95) 

# PANASpos by condition and time
PANASpos_time_descr <- summarySEwithin(affStates, measurevar="PANAS_pos", betweenvars="condition", withinvars="time", idvar="ID", conf.interval=.95) 

# PANASpos by condition, time, and sex
PANASpos_time_sex_descr <- summarySEwithin(affStates, measurevar="PANAS_pos", betweenvars=c("condition", "sex"), withinvars="time", idvar="ID", conf.interval=.95) 

# rmANOVA with condition and time and sex as covariate

# check normality assumption
PANASposqqplot <- ggqqplot(affStates, "PANAS_pos", ggtheme = theme_bw()) +
  facet_grid(time ~ condition, labeller = "label_both") # looks ok
#PANASposqqplot

# run rmANOVA
PANASpos.fit <- aov_ez("ID","PANAS_pos", affStates, between="condition", within="time", covariate="sex")
summary(PANASpos.fit)
nice(PANASpos.fit, es="pes")

# main effect of time with decreased positive mood post stress exposure across groups
# no interaction of condition x time
# interaction of sex x time

# plot scores split for sex
PANASpos.fitSexPlot <- ggboxplot(
  affStates, x = "time", y = "PANAS_pos",
  color = "sex", palette = "cbPalette",
  facet.by = "condition", short.panel.labs = FALSE)
PANASpos.fitSexPlot

# men show less decrease in pos. mood from pre to post
```
There were no group differences in positive mood but an overall decrease from pre to post stress induction. Men displayed a slightly smaller decrease compared to women.

### Negative Mood
```{r negative mood - PANASneg, plot to identify outliers}
# plot scores by group and time
PANASnegPlot <- ggplot(affStates, aes(time, PANAS_neg, fill=condition)) + 
    geom_violin() +  
    geom_boxplot(width=0.2, position=position_dodge(1)) +
    xlab("Time") +
    ylab("Negative Mood") +
    scale_fill_manual(values=c(colour1, colour2)) +
    laura_theme
PANASnegPlot # some outliers

# get outlier IDs
PANASnegOutlierIDs <- affStates %>%
  group_by(condition, time) %>%
  identify_outliers(PANAS_neg) 

# output all outliers
#unique(PANASnegOutlierIDs$ID)

# exclude all identified outliers
#affStates_PANASneg1 <- affStates[! (affStates$ID=="EC53" | affStates$ID=="EC38" |
#                                            affStates$ID=="EC62" | affStates$ID=="EC97" |
#                                            affStates$ID=="EC86" | affStates$ID=="EC68"), ] # doesn't change results

# output extreme outliers
#unique(PANASnegOutlierIDs$ID[PANASnegOutlierIDs$is.extreme==T]) 

# exclude extreme outlier
#affStates_PANASneg2 <- affStates[affStates$ID!="EC53", ] # doesn't change results
```
There were some outliers with respect to negative mood but since they did not affect results, we kept them.

```{r negative mood - PANASneg}
# PANASneg by condition
PANASneg_group_descr <- summarySE(affStates, measurevar="PANAS_neg", groupvars="condition", conf.interval=.95) 

# PANASneg by condition and time
PANASneg_time_descr <- summarySEwithin(affStates, measurevar="PANAS_neg", betweenvars="condition", withinvars="time", idvar="ID", conf.interval=.95) 

# PANASneg by condition, sex, and time
PANASneg_time_sex_descr <- summarySEwithin(affStates, measurevar="PANAS_neg", betweenvars=c("condition", "sex"), withinvars="time", idvar="ID", conf.interval=.95) 

# rmANOVA with condition and time and sex as covariate

# check normality assumption
PANASnegqqplot <- ggqqplot(affStates, "PANAS_neg", ggtheme = theme_bw()) +
  facet_grid(time ~ condition, labeller = "label_both") # bit crooked
#PANASnegqqplot

# run rmANOVA
PANASneg.fit <- aov_ez("ID","PANAS_neg", affStates, between="condition", within="time", covariate="sex")
summary(PANASneg.fit)
nice(PANASneg.fit, es="pes")

# main effect of condition (YC shows slightly higher overall neg. mood )
# main effect of time shows increase in neg. mood
# no interaction of condition x time

# confirm results with robust ANOVA
PANASneg.fitrobust <- bwtrim(PANAS_neg ~ condition*factor(time), ID, data = affStates)
PANASneg.fitrobust
```
There were sig. group differences in negative mood with slightly higher overall scores in YC compared to EC. We observed an overall decrease from pre to post stress induction but no interaction of group x time.

# Escape Behaviour

## Activity (moves per minute)
```{r activity - escape behaviour test, plot to identify outliers}
# boxplot by group, phase, and block
activityBoxPlot <- ggplot(escapeBehav, aes(factor(phase), mpm, fill=condition)) + 
    geom_violin() +  
    geom_boxplot(width=0.2, position=position_dodge(1)) +
    ylab("Activity (moves/minute)") +
    xlab("Phase") +
    scale_fill_manual(values=c(colour1, colour2)) +
    laura_theme
activityBoxPlot # some outliers

# get outlier IDs
activityOutlierIDs <- escapeBehav %>%
  group_by(condition, phase, block) %>%
  identify_outliers(mpm) 

# output all outliers
#unique(activityOutlierIDs$ID)

# exclude all identified outliers
#escapeBehav_activity <- escapeBehav[! (escapeBehav$ID=="EC87" | escapeBehav$ID=="EC80" |
#                                       escapeBehav$ID=="EC71" | escapeBehav$ID=="CSE07" |
#                                       escapeBehav$ID=="CSE74" | escapeBehav$ID=="CSE107" |
#                                       escapeBehav$ID=="CSE27" | escapeBehav$ID=="CSE63" |
#                                       escapeBehav$ID=="CSE68" | escapeBehav$ID=="CSE86"), ] # excluding them changes results but doesn't really seem warranted, few extreme outliers

# output extreme outliers
#unique(activityOutlierIDs$ID[activityOutlierIDs$is.extreme==T]) #none

# exclude extreme outliers
#escapeBehav_activity2 <- escapeBehav[! (escapeBehav$ID=="EC71" | escapeBehav$ID=="EC87"), ] # excluding them changes results but doesn't really seem warranted
```
There were some outliers with respect to activity but few of them represented extreme deviations and it didn't seem warranted to exclude them.

```{r activity - escape behaviour test}
# Activity by condition
activity_group_descr <- summarySE(escapeBehav, measurevar="mpm", groupvars="condition", conf.interval=.95) 

# Activity by condition and phase
activity_phase_descr <- summarySEwithin(escapeBehav, measurevar="mpm", betweenvars="condition", withinvars="phase", idvar="ID", conf.interval=.95) 

# Activity by condition, phase, and block
activity_phase_block_descr <- summarySEwithin(escapeBehav, measurevar="mpm", betweenvars="condition", withinvars=c("phase", "block"), idvar="ID", conf.interval=.95) 

# Activity by condition, phase and trial
activity_phase_trial_descr <- summarySEwithin(escapeBehav, measurevar="mpm", betweenvars="condition", withinvars=c("phase", "trial"), idvar="ID", conf.interval=.95) 

# Activity by condition, phase, and sex
activity_phase_sex_descr <- summarySEwithin(escapeBehav, measurevar="mpm", betweenvars=c("condition", "sex"), withinvars="phase", idvar="ID", conf.interval=.95) 

# plot by group, phase and trial for EC
activityPlotEC <- ggplot(escapeBehav[escapeBehav$condition=="EC", ], aes(factor(trial), mpm, fill=phase)) +
  geom_violin() +  
  geom_boxplot(width=0.2, position=position_dodge(1)) +
  facet_grid(~factor(block)) +
  scale_y_continuous(breaks=seq(0,900,100)) +
  ylab("Activity") +
  xlab("Trial") +
  scale_fill_manual(values=c(colour1, colour2))  +
  ggtitle("Activity by Phase over Trials and Blocks in EC") +
  laura_theme

# plot by group, phase and trial for EC
activityPlotYC <- ggplot(escapeBehav[escapeBehav$condition=="YC", ], aes(factor(trial), mpm, fill=phase)) +
  geom_violin() +  
  geom_boxplot(width=0.2, position=position_dodge(1)) +
  facet_grid(~factor(block)) +
  scale_y_continuous(breaks=seq(0,900,100)) +
  ylab("Activity") +
  xlab("Trial") +
  scale_fill_manual(values=c(colour1, colour2))  +
  ggtitle("Activity by Phase over Trials and Blocks in YC") +
  laura_theme

ggarrange(activityPlotEC, activityPlotYC, ncol = 1, nrow = 2)

# rmANOVA with condition, phase, block, trial and sex as covariate

# check normality assumption
activityqqplot <- ggqqplot(escapeBehav, "mpm", ggtheme = theme_bw()) +
  facet_grid(phase ~ condition, labeller = "label_both") # bit crooked
#activityqqplot 

# run rmANOVA
activity.fit <- aov_ez("ID","mpm", escapeBehav, between="condition", within=c("phase", "block", "trial"), covariate="sex")
summary(activity.fit)
nice(activity.fit, es="pes")

# main effect of phase --> more activity in stress phase
# main effect of block --> more activity in block 2
# main effect of trial --> increasing activity over trials

# interaction of block x trial
# interaction of phase x block x trial
# interaction of condition x phase x block x trial

# sex effect --> men show more activity
# interaction of sex x phase x block x trial

# instead of multiple post-hoc comparisons, just check summary tables and plots

#activity.fitrobust <- bwtrim(mpm ~ condition*factor(phase), ID, data = escapeBehav) # bwtrim can only handle one within-subject factor at a time
#activity.fitrobust

# plot by group and block only
activityPlotBlock <- ggplot(escapeBehav, aes(condition, mpm, fill=factor(block))) +
  geom_violin() +  
  geom_boxplot(width=0.2, position=position_dodge(1)) +
  ylab("Activity") +
  xlab("Experimental Condition") +
  scale_fill_manual(values=c(colour1, colour2))  +
  laura_theme
activityPlotBlock
```
There was no main effect of group but a significant difference in activity between the free exploration phase and the stress phase as well as between blocks and across trials. Participants showed increased activity over time and blocks and generally lower activity in the stress phase. Complex interaction effects...

## Escapes 
```{r escapes - escape behaviour test, plot to identify outliers}
# aggregate by ID, phase and block because sum_escapes was computed across trials
escapes <- aggregate(escapeBehav$sum_escapes, list(escapeBehav$ID, escapeBehav$phase, escapeBehav$block), max)
colnames(escapes) <- c("ID", "phase", "block", "sum_escapes_block")
escapes <- join(escapes, demo[, c(1:3)]) # add condition and sex

# escapes are most interesting for stress phase!
escapesStress <- escapes[escapes$phase!="NoStress", ]

# check for outliers by group
escapesOutlier <- ggplot(escapesStress, aes(condition, sum_escapes_block, fill=condition)) + 
    geom_violin() +
    geom_boxplot(width=0.2) +
    stat_sum_single(mean) +
    xlab("Experimental Condition") +
    ylab("Escapes") +
    scale_fill_manual(values=c(colour1, colour2)) +
    laura_theme
escapesOutlier # no outliers
```
There were no outliers with respect to escape rate.

```{r escapes - escape behaviour test }
# Escapes by condition
escapes_group_descr <- summarySE(escapesStress, measurevar="sum_escapes_block", groupvars="condition", conf.interval=.95) 

# Escapes by condition and block
escapes_block_descr <- summarySEwithin(escapesStress, measurevar="sum_escapes_block", betweenvars="condition", withinvars="block", conf.interval=.95) 

# Escapes by condition, block, sex
escapes_block_sex_descr <- summarySEwithin(escapesStress, measurevar="sum_escapes_block", betweenvars=c("condition", "sex"), withinvars="block", idvar="ID", conf.interval=.95) 

# plot by group and block
escapePlot <- ggplot(escapesStress, aes(factor(block), sum_escapes_block, fill=condition)) +
  geom_violin() +  
  geom_boxplot(width=0.2, position=position_dodge(1)) +
  ylab("Escapes") +
  xlab("Trial") +
  scale_fill_manual(values=c(colour1, colour2))  +
  ggtitle("Activity by Group over Blocks") +
  laura_theme
escapePlot

# rmANOVA with condition, phase, block, trial and sex as covariate

# check normality assumption
escapeqqplot <- ggqqplot(escapesStress, "sum_escapes_block", ggtheme = theme_bw()) +
  facet_grid(block ~ condition, labeller = "label_both") # bit crooked
#escapeqqplot

# run rmANOVA
escapes.fit <- aov_ez("ID","sum_escapes_block", escapesStress, between="condition", within="block", covariate="sex")
summary(escapes.fit)
nice(escapes.fit, es="pes")

# main effect of block 
# interaction of condition x block 
# trend for an interaction of sex x block

# post-hoc comparisons - condition and block
ref1 <- lsmeans(escapes.fit, specs = c("condition", "block"))
pwc <- contrast(ref1, method="pairwise", adjust="holm")
pwc

# EC improves from block 1 to 2, YC doesn't (escape rate even decreases slightly)

# confirm results with robust ANOVA
escapes.fitrobust <- bwtrim(sum_escapes_block ~ condition*factor(block), ID, data = escapesStress) 
escapes.fitrobust

# plot by sex and block only
escapePlotSex <- ggplot(escapeBehav, aes(sex, sum_escapes_block, fill=factor(block))) +
  geom_violin() +  
  geom_boxplot(width=0.2, position=position_dodge(1)) +
  ylab("Escapes") +
  xlab("Sex") +
  scale_fill_manual(values=c(colour1, colour2))  +
  laura_theme
escapePlotSex

# men show increase in escapes, whereas women show decrease over blocks
```
EC managed to escape more often in block 2 compared to block 1, whereas YC did not improve (scores denote rather a slight decrease!). Overall participants escaped more often in block 2. Men improved more than women from block 1 to block 2. 

## Exploration 
```{r exploration - escape behaviour test, plot to identify outlier}
# boxplot by group, phase, and block
explorationBoxPlot <- ggplot(escapeBehav, aes(factor(phase), exploration, fill=condition)) + 
    geom_violin() +  
    geom_boxplot(width=0.2, position=position_dodge(1)) +
    ylab("Exploration (unique places visited/minute)") +
    xlab("Phase") +
    scale_fill_manual(values=c(colour1, colour2)) +
    laura_theme
explorationBoxPlot # some outliers

# get outlier IDs
explorationOutlierIDs <- escapeBehav %>%
  group_by(condition, phase, block) %>%
  identify_outliers(exploration) 

# output all outliers
#unique(explorationOutlierIDs$ID)

# exclude all identified outliers
#escapeBehav_exploration <- escapeBehav[! (escapeBehav$ID=="EC39" | escapeBehav$ID=="EC80" |
#                                       escapeBehav$ID=="EC87" | escapeBehav$ID=="CSE07" |
#                                       escapeBehav$ID=="CSE101" | escapeBehav$ID=="CSE51" |
#                                       escapeBehav$ID=="CSE63"), ] #doesn't affect results

# output extreme outliers
#unique(explorationOutlierIDs$ID[explorationOutlierIDs$is.extreme==T]) #none
```
There were some outlier with respect to exploration but since they did not affect results, we kept them.

```{r exploration - escape behaviour test}
# Exploration by condition
exploration_group_descr <- summarySE(escapeBehav, measurevar="exploration", groupvars="condition", conf.interval=.95) 

# Exploration by condition and phase
exploration_phase_descr <- summarySEwithin(escapeBehav, measurevar="exploration", betweenvars="condition", withinvars="phase", idvar="ID", conf.interval=.95) 

# Exploration by condition, phase, and block
exploration_phase_block_descr <- summarySEwithin(escapeBehav, measurevar="exploration", betweenvars="condition", withinvars=c("phase", "block"), idvar="ID", conf.interval=.95) 

# Exploration by condition, phase and trial
exploration_phase_trial_descr <- summarySEwithin(escapeBehav, measurevar="exploration", betweenvars="condition", withinvars=c("phase", "trial"), idvar="ID", conf.interval=.95) 

# Exploration by condition, phase, and sex
exploration_phase_sex_descr <- summarySEwithin(escapeBehav, measurevar="exploration", betweenvars=c("condition", "sex"), withinvars="phase", idvar="ID", conf.interval=.95) 

# plot by group, phase and trial for EC
explorationPlotEC <- ggplot(escapeBehav[escapeBehav$condition=="EC", ], aes(factor(trial), exploration, fill=phase)) +
  geom_violin() +  
  geom_boxplot(width=0.2, position=position_dodge(1)) +
  facet_grid(~factor(block)) +
  scale_y_continuous(breaks=seq(0,900,100)) +
  ylab("Exploration") +
  xlab("Trial") +
  scale_fill_manual(values=c(colour1, colour2))  +
  ggtitle("Exploration by Phase over Trials and Blocks in EC") +
  laura_theme

# plot by group, phase and trial for EC
explorationPlotYC <- ggplot(escapeBehav[escapeBehav$condition=="YC", ], aes(factor(trial), exploration, fill=phase)) +
  geom_violin() +  
  geom_boxplot(width=0.2, position=position_dodge(1)) +
  facet_grid(~factor(block)) +
  scale_y_continuous(breaks=seq(0,900,100)) +
  ylab("Exploration") +
  xlab("Trial") +
  scale_fill_manual(values=c(colour1, colour2))  +
  ggtitle("Exploration by Phase over Trials and Blocks in YC") +
  laura_theme

ggarrange(explorationPlotEC, explorationPlotYC, ncol = 1, nrow = 2)

# rmANOVA with condition, phase, block, trial and sex as covariate

# check normality assumption
explorationqqplot <- ggqqplot(escapeBehav, "exploration", ggtheme = theme_bw()) +
  facet_grid(phase ~ condition, labeller = "label_both") # crooked
#explorationqqplot

# run rmANOVA
exploration.fit <- aov_ez("ID","exploration", escapeBehav, between="condition", within=c("phase", "block", "trial"), covariate="sex")
summary(exploration.fit)
nice(exploration.fit, es="pes")

# main effect of phase --> more exploration in stress phase
# main effect of block --> more exploration in block 2
# main effect of trial --> increasing exploration over trials

# interaction of block x trial
# interaction of condition x block x trial
# interaction of condition x phase x block x trial

# sex effect
# interaction of sex x phase x block x trial

# instead of multiple post-hoc comparisons, just check summary tables and plots

#exploration.fitrobust <- bwtrim(exploration ~ condition*factor(phase), ID, data = escapeBehav) # bwtrim can only handle one within-subject factor at a time
#exploration.fitrobust

# plot by group and block only
explorationPlotBlock <- ggplot(escapeBehav, aes(condition, exploration, fill=factor(block))) +
  geom_violin() +  
  geom_boxplot(width=0.2, position=position_dodge(1)) +
  ylab("Exploration") +
  xlab("Experimental Condition") +
  scale_fill_manual(values=c(colour1, colour2))  +
  laura_theme
explorationPlotBlock

# men explore more than women
```
There was no main effect of group but a significant difference in exploration between the free exploration phase and the stress phase as well as between blocks and across trials. Participants showed increased exploration over time and blocks and generally lower exploration in the stress phase. The interaction of condition x phase x trial indicated that YC explored much more during the stress phase than EC and this difference became more pronounced over trials.

## Efficiency 
```{r efficiency - escape behaviour test, plot to identify outliers}
# aggregate by ID, phase and block because overall_efficiency was computed across trials
efficiency <- aggregate(escapeBehav$block_efficiency, list(escapeBehav$ID, escapeBehav$phase, escapeBehav$block), max)
colnames(efficiency) <- c("ID", "phase", "block", "overall_efficiency")
efficiency <- join(efficiency, demo[, c(1:3)]) # add condition and sex

# Efficiency is most interesting for stress phase!
efficiencyStress <- efficiency[efficiency$phase!="NoStress", ]

# check for outliers by group
efficiencyOutlier <- ggplot(efficiencyStress, aes(condition, overall_efficiency, fill=condition)) + 
    geom_violin() +
    geom_boxplot(width=0.2) +
    stat_sum_single(mean) +
    xlab("Experimental Condition") +
    ylab("Efficiency (escapes/activity)") +
    scale_fill_manual(values=c(colour1, colour2)) +
    laura_theme
efficiencyOutlier # some outliers

# get outlier IDs
efficiencyOutlierIDs <- efficiencyStress %>%
  group_by(condition, phase) %>%
  identify_outliers(overall_efficiency) 

# output all outliers
#unique(efficiencyOutlierIDs$ID)

# exclude all identified outliers
#efficiencyStress <- efficiencyStress[! (efficiencyStress$ID=="EC06" | efficiencyStress$ID=="EC11" | 
#                                         efficiencyStress$ID=="EC37" | efficiencyStress$ID=="EC71" |
#                                         efficiencyStress$ID=="EC84" | efficiencyStress$ID=="CSE01" |
#                                         efficiencyStress$ID=="CSE103" | efficiencyStress$ID=="CSE116" |
#                                         efficiencyStress$ID=="CSE116" | efficiencyStress$ID=="CSE32" |
#                                         efficiencyStress$ID=="CSE28" | efficiencyStress$ID=="CSE59" |
#                                         efficiencyStress$ID=="CSE65" | efficiencyStress$ID=="CSE67" |
#                                         efficiencyStress$ID=="CSE74" | efficiencyStress$ID=="CSE84"), ] #doesn't affect results 

# output extreme outliers
#unique(efficiencyOutlierIDs$ID[efficiencyOutlierIDs$is.extreme==T]) #none
```
There were some outliers with respect to efficiency but excluding them did not affect the results, so we kept them.

```{r efficiency - escape behaviour test}
# Efficiency by condition
efficiency_group_descr <- summarySE(efficiencyStress, measurevar="overall_efficiency", groupvars="condition", conf.interval=.95, na.rm=T) 

# Efficiency by condition and block
efficiency_block_descr <- summarySEwithin(efficiencyStress, measurevar="overall_efficiency", betweenvars="condition", withinvars="block", conf.interval=.95, na.rm=T) 

# Efficiency by condition, block, sex
efficiency_block_sex_descr <- summarySEwithin(efficiencyStress, measurevar="overall_efficiency", betweenvars=c("condition", "sex"), withinvars="block", idvar="ID", conf.interval=.95, na.rm=T) 

# rmANOVA with condition, phase, block, trial and sex as covariate

# check normality assumption
efficiencyqqplot <- ggqqplot(efficiencyStress, "overall_efficiency", ggtheme = theme_bw()) +
  facet_grid(block ~ condition, labeller = "label_both") # crooked
#efficiencyqqplot

# run rmANOVA
efficiency.fit <- aov_ez("ID","overall_efficiency", efficiencyStress, between="condition", within="block", covariate="sex")
summary(efficiency.fit)
nice(efficiency.fit, es="pes")

# trend effect of block 
# interaction of condition x block 
# sex x block interaction

# post-hoc comparisons - condition and block
ref1 <- lsmeans(efficiency.fit, specs = c("condition", "block"))
pwc <- contrast(ref1, method="pairwise", adjust="holm")
pwc

# YC shows less efficient behaviour (higher scores) from block 1 to 2, EC doesn't change (even shows slight improvement)

# confirm results with robust ANOVA
efficiency.fitrobust <- bwtrim(overall_efficiency ~ condition*factor(block), ID, data = efficiencyStress)
efficiency.fitrobust
```
Whereas EC and YC did not differ in efficiency in block 1 (although YC had slightly better scores), YC showed sig. less efficient behaviour in block 2 compared to EC. There was also an interaction of sex x block.

# Plots for Paper

## Figure 1
```{r Figure 1 - simple group comparisons}
# stressor aversiveness
fig1avers <- ggplot(ratingMean_avers, aes(x=condition, y=aversive_rating, colour=condition)) + 
  geom_point(size=5, position=position_dodge2(width=.5), alpha = 0.7) +
  stat_summary(fun.data=mean_se, fun.args = list(mult=1), 
                 geom="errorbar", color="black", width=.1, size=1) +
  stat_summary(fun.y=mean, geom="point", shape=21, fill="white", color="black", size=4, stroke=1) +
  scale_y_continuous(breaks=seq(1,7,1)) +
  ylab("Stressor Aversiveness") +
  xlab("Group") +
  scale_colour_manual(values=c(colour1, colour2)) +
  geom_signif(comparisons = list(c("EC","YC")), y_position=7.5,
              tip_length=0, vjust=.1, map_signif_level=T, size=0.8, textsize=4, colour="black") +
  laura_theme + theme(legend.position="none") 
fig1avers

# perceived control
fig1ctrl<- ggplot(ratingMean_ctrl, aes(x=condition, y=control_rating, colour=condition)) + 
  geom_point(size=5, position=position_dodge2(width=.5), alpha = 0.7) +
  stat_summary(fun.data=mean_se, fun.args = list(mult=1), 
                 geom="errorbar", color="black", width=.1, size=1) +
  stat_summary(fun.y=mean, geom="point", shape=21, fill="white", color="black", size=4, stroke=1) +
  scale_y_continuous(breaks=seq(1,7,1)) +
  ylab("Perceived Control") +
  xlab("Group") +
  scale_colour_manual(values=c(colour1, colour2)) +
  geom_signif(comparisons = list(c("EC","YC")), y_position=7.5,
              tip_length=0, vjust=.5, map_signif_level=T, size=0.8, textsize=8, colour="black") +
  laura_theme + theme(legend.position="none") 
fig1ctrl

# helplessness
fig1help <- ggplot(ratingMean, aes(x=condition, y=helpless_rating, colour=condition)) + 
  geom_point(size=5, position=position_dodge2(width=.5), alpha = 0.7) +
  stat_summary(fun.data=mean_se, fun.args = list(mult=2), 
                 geom="errorbar", color="black", width=.1, size=1) +
  stat_summary(fun.y=mean, geom="point", shape=21, fill="white", color="black", size=4, stroke=1) +
  scale_y_continuous(breaks=seq(1,7,1)) +
  ylab("Helplessness") +
  xlab("Group") +
  scale_colour_manual(values=c(colour1, colour2)) +
  geom_signif(comparisons = list(c("EC","YC")), y_position=7.5,
              tip_length=0, vjust=.5, map_signif_level=T, size=0.8, textsize=8, colour="black") +
  laura_theme + theme(legend.position="none") 
fig1help

# RT (t-test returns sig. but analysis with rmANOVA shows insig. post-hoc test)
fig1rt <- ggplot(RTMean, aes(x=condition, y=rt, colour=condition)) + 
  geom_point(size=5, position=position_dodge2(width=.5), alpha = 0.7) +
  stat_summary(fun.data=mean_se, fun.args = list(mult=2), 
                 geom="errorbar", color="black", width=.1, size=1) +
  stat_summary(fun.y=mean, geom="point", shape=21, fill="white", color="black", size=4, stroke=1) +
  scale_y_continuous(breaks=seq(200,1000,100)) +
  ylab("Reaction Time (ms)") +
  xlab("Group") +
  scale_colour_manual(values=c(colour1, colour2)) +
  geom_signif(comparisons = list(c("EC","YC")), y_position=1100,
              tip_length=0, vjust=.5, map_signif_level=T, size=0.8, textsize=8, colour="black") +
  laura_theme + theme(legend.position="none") 
fig1rt
```

## Figure 2
```{r Figure 2 - efficiency interaction effects}
# efficiency - condition x block interaction effect
fig2efficiency <- ggplot(data=efficiencyStress %>% 
                           group_by(condition, block), 
                         aes(x=as.factor(block), y = overall_efficiency, group = condition, 
                             color = condition, fill = condition)) + 
  geom_point(size = 5, position=position_dodge2(width=.5), alpha = 0.8) + 
  stat_summary(fun.data ="mean_se", geom="errorbar", size = 1, width = .2,
               position=position_dodge(.5), color="black") + # add error bars for se
  stat_summary(fun.y ="mean", geom="point", shape=21, fill="white", color="black", size=4, stroke=1,
               position=position_dodge2(.5)) + # add mean values
  scale_y_continuous(breaks=seq(0,300,50)) +
  ylab("Efficiency") +
  xlab("Block") +
  scale_colour_manual(values=c(colour1, colour2))  +
  annotate("rect", xmin=1.875, xmax=2.125, ymin=300, ymax=300, alpha=1, colour="black", size=0.8) + # add sig. line for EC 2 vs. YC 2
  annotate("rect", xmin=1.125, xmax=2.125, ymin=270, ymax=270, alpha=1, colour="black", size=0.8) + # add sig. line for YC 1 vs. YC 2
  annotate("text", x=1.6, y=274, label="**", cex=8) + # add sig. asterisks for YC 1 vs. YC 2
  annotate("text", x=2, y=304, label="**", cex=8) + # add sig. asterisks for EC2 vs. YC 2
  laura_theme + theme(legend.position = c(0.1, 0.9), legend.background = element_rect(fill = "transparent", color = NA))
fig2efficiency
```
